trigger:
  branches:
    include:
      - main
  paths:
    include:
      - schema/*
      - scripts/*
      - scripts/azure-pipelines.yml

pool:
  vmImage: ubuntu-latest

steps:
  - checkout: self

  - bash: |
      set -euo pipefail

      echo "Validating required variables..."
      for v in ASTRA_DB_ID ASTRA_REGION ASTRA_TOKEN ASTRA_KEYSPACE; do
        if [ -z "${!v:-}" ]; then
          echo "Missing variable: $v"
          echo "Set it as a pipeline variable (mark secrets as secret)."
          exit 1
        fi
      done

      echo "Running schema apply..."
      chmod +x scripts/apply-schema.sh
      scripts/apply-schema.sh
    displayName: "Apply versioned schema scripts (DDL only)"
    env:
      ASTRA_DB_ID: $(ASTRA_DB_ID)
      ASTRA_REGION: $(ASTRA_REGION)
      ASTRA_TOKEN: $(ASTRA_TOKEN)
      ASTRA_KEYSPACE: $(ASTRA_KEYSPACE)

  - bash: |
      set -euo pipefail

      echo "Generating latest schema snapshot..."
      chmod +x scripts/generate-schema-snapshot.sh
      scripts/generate-schema-snapshot.sh snapshots/latest

      echo "Snapshot files:"
      ls -la snapshots/latest || true
    displayName: "Generate schema snapshot (latest)"
    env:
      ASTRA_DB_ID: $(ASTRA_DB_ID)
      ASTRA_REGION: $(ASTRA_REGION)
      ASTRA_TOKEN: $(ASTRA_TOKEN)
      ASTRA_KEYSPACE: $(ASTRA_KEYSPACE)

  - publish: snapshots/latest
    artifact: schema-snapshot-latest
    displayName: "Publish schema snapshot artifact (latest)"
