trigger:
  branches:
    include:
      - main
  paths:
    include:
      - schema/*
      - scripts/*
      - azure-pipelines.yml

pool:
  vmImage: ubuntu-latest

variables:
  # These should be set in Azure DevOps as secret variables (recommended)
  # ASTRA_DB_ID
  # ASTRA_REGION
  # ASTRA_TOKEN
  # ASTRA_KEYSPACE

steps:
  - checkout: self

  - bash: |
      set -euo pipefail

      echo "Validating required variables..."
      for v in ASTRA_DB_ID ASTRA_REGION ASTRA_TOKEN ASTRA_KEYSPACE; do
        if [ -z "${!v:-}" ]; then
          echo "Missing variable: $v"
          echo "Set it as a pipeline variable (mark secrets as secret)."
          exit 1
        fi
      done

      chmod +x scripts/apply-schema.sh
      scripts/apply-schema.sh
    displayName: "Apply AstraDB schema scripts (DDL only)"
    env:
      ASTRA_DB_ID: $(ASTRA_DB_ID)
      ASTRA_REGION: $(ASTRA_REGION)
      ASTRA_TOKEN: $(ASTRA_TOKEN)
      ASTRA_KEYSPACE: $(ASTRA_KEYSPACE)
